<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drag Race Philippines Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: #F3F4F6;
        }
        .main-button {
            background: linear-gradient(to right, #D946EF, #EC4899);
            transition: transform 0.2s, box-shadow 0.2s;
            border: 2px solid transparent;
        }
        .main-button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(236, 72, 153, 0.7);
        }
        .secondary-button {
            background-color: #374151;
            border: 2px solid #4B5563;
            transition: transform 0.2s, box-shadow 0.2s, background-color 0.2s;
        }
        .secondary-button:hover {
            background-color: #4B5563;
            border-color: #6B7280;
            transform: scale(1.02);
        }
        .queen-card { transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out, border-color 0.2s; }
        .queen-card:hover { transform: scale(1.05); box-shadow: 0 0 15px rgba(236, 72, 153, 0.5); }
        .queen-card.selected { transform: scale(1.05); box-shadow: 0 0 20px rgba(236, 72, 153, 1); border-color: #EC4899; }
        .btn-primary { background: linear-gradient(to right, #D946EF, #EC4899); transition: transform 0.2s, box-shadow 0.2s, background 0.2s; }
        .btn-primary:hover:not(:disabled) { transform: scale(1.05); box-shadow: 0 0 15px rgba(236, 72, 153, 0.7); }
        .btn-primary:disabled { background: #4B5563; cursor: not-allowed; transform: scale(1); box-shadow: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .track-record-table th, .track-record-table td { padding: 0.5rem; text-align: center; border: 1px solid #374151; }
        .track-record-table th { vertical-align: top; }
        .placement-WIN { background-color: #a942a9; color: white; font-weight: bold; }
        .placement-HIGH { background-color: #3b82f6; }
        .placement-SAFE { background-color: #4b5563; }
        .placement-LOW { background-color: #ca8a04; }
        .placement-BTM2 { background-color: #d97706; }
        .placement-ELIM { background-color: #be123c; color: white; font-weight: bold; }
        .critique-card { border-left-width: 4px; }
        .critique-good { border-left-color: #3b82f6; }
        .critique-safe { border-left-color: #6b7280; }
        .critique-bad { border-left-color: #d97706; }
    </style>
</head>
<body class="h-full flex flex-col antialiased items-center justify-center p-4">

    <div id="menu-view" class="w-full max-w-md text-center">
        <h1 class="text-5xl font-black tracking-tight text-transparent bg-clip-text bg-gradient-to-r from-fuchsia-500 to-pink-500 mb-4">Drag Race Simulator</h1>
        <p class="text-gray-400 mb-8">Choose your destiny, queen.</p>
        <div class="space-y-4">
            <button id="standard-mode-btn" class="main-button w-full py-4 rounded-lg text-xl font-bold uppercase tracking-wider">Standard Mode</button>
            <button id="rupaul-mode-btn" class="secondary-button w-full py-4 rounded-lg text-xl font-bold uppercase tracking-wider">RuPaul Mode</button>
        </div>
    </div>

    <div id="selection-view" class="hidden w-full h-full flex-grow container mx-auto flex flex-col">
        <header class="text-center mb-6">
            <h1 class="text-4xl md:text-5xl font-black tracking-tight text-transparent bg-clip-text bg-gradient-to-r from-fuchsia-500 to-pink-500">Assemble Your Cast</h1>
            <p id="instructions" class="text-gray-400 mt-2">Select 8 to 15 queens.</p>
        </header>
        <main class="flex-grow flex flex-col md:flex-row gap-6 min-h-0">
            <div class="md:w-3/5 lg:w-2/3 flex flex-col"><div id="queen-grid" class="flex-grow grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-3 p-2 overflow-y-auto no-scrollbar rounded-lg bg-gray-900/50"></div></div>
            <div id="cast-details" class="md:w-2/5 lg:w-1/3 bg-gray-900/50 rounded-lg p-6 flex flex-col">
                <div class="flex-grow flex flex-col">
                    <h2 class="text-2xl font-bold text-center mb-4">Your Cast</h2>
                    <p id="cast-counter" class="text-center text-gray-400 mb-4">Selected: 0 / 15</p>
                    <div id="cast-list" class="flex-grow overflow-y-auto no-scrollbar pr-2 space-y-2"><p id="cast-placeholder" class="text-gray-500 text-center mt-8">Your selected queens will appear here.</p></div>
                </div>
                <button id="start-competition-button" class="btn-primary w-full py-3 mt-6 rounded-lg text-lg font-bold uppercase tracking-wider" disabled>Start Competition!</button>
            </div>
        </main>
    </div>

    <div id="simulation-view" class="hidden w-full h-full flex-grow container mx-auto flex flex-col">
        <header id="sim-header" class="text-center mb-6">
            <h1 id="episode-header" class="text-3xl md:text-4xl font-black tracking-tight text-transparent bg-clip-text bg-gradient-to-r from-fuchsia-500 to-pink-500"></h1>
            <p id="phase-subheader" class="text-gray-400 mt-2"></p>
        </header>
        <main id="results-container" class="flex-grow bg-gray-900/50 rounded-lg p-4 md:p-6 overflow-y-auto no-scrollbar"></main>
        <footer class="mt-6 text-center">
            <button id="advance-button" class="btn-primary px-8 py-3 rounded-lg text-lg font-bold uppercase tracking-wider"></button>
            <button id="restart-button" class="hidden bg-gray-600 hover:bg-gray-500 text-white px-8 py-3 rounded-lg text-lg font-bold uppercase tracking-wider">Start New Season</button>
        </footer>
    </div>

    <script>
        // --- DATA ---
        const queens = [
             // S1 (Recalculated)
            { id: 'brigiding', name: 'Brigiding', season: 1, stats: { runway: 7, comedy: 7, acting: 7, dance: 8, design: 5, lipsync: 8 } },
            { id: 'corazon', name: 'Corazon', season: 1, stats: { runway: 6, comedy: 5, acting: 6, dance: 6, design: 8, lipsync: 7 } },
            { id: 'eva_le_queen', name: 'Eva Le Queen', season: 1, stats: { runway: 8, comedy: 9, acting: 8, dance: 6, design: 7, lipsync: 7 } },
            { id: 'gigi_era', name: 'Gigi Era', season: 1, stats: { runway: 6, comedy: 6, acting: 7, dance: 7, design: 5, lipsync: 9 } },
            { id: 'lady_morgana', name: 'Lady Morgana', season: 1, stats: { runway: 5, comedy: 8, acting: 7, dance: 6, design: 6, lipsync: 7 } },
            { id: 'marina_summers', name: 'Marina Summers', season: 1, stats: { runway: 9, comedy: 6, acting: 7, dance: 9, design: 9, lipsync: 8 } },
            { id: 'minty_fresh', name: 'Minty Fresh', season: 1, stats: { runway: 9, comedy: 7, acting: 7, dance: 8, design: 7, lipsync: 9 } },
            { id: 'precious_paula_nicole', name: 'Precious Paula Nicole', season: 1, stats: { runway: 8, comedy: 8, acting: 9, dance: 7, design: 7, lipsync: 10 } },
            { id: 'prince', name: 'Prince', season: 1, stats: { runway: 7, comedy: 5, acting: 6, dance: 6, design: 5, lipsync: 7 } },
            { id: 'turing', name: 'Turing', season: 1, stats: { runway: 7, comedy: 7, acting: 8, dance: 9, design: 6, lipsync: 8 } },
            { id: 'vinas_deluxe', name: 'Viñas DeLuxe', season: 1, stats: { runway: 8, comedy: 10, acting: 8, dance: 7, design: 7, lipsync: 8 } },
            { id: 'xilhouete', name: 'Xilhouete', season: 1, stats: { runway: 9, comedy: 8, acting: 8, dance: 7, design: 9, lipsync: 8 } },
            // S2 (Recalculated)
            { id: 'arizona_brandy', name: 'Arizona Brandy', season: 2, stats: { runway: 7, comedy: 9, acting: 8, dance: 7, design: 7, lipsync: 9 } },
            { id: 'astrid_mercury', name: 'Astrid Mercury', season: 2, stats: { runway: 7, comedy: 6, acting: 7, dance: 8, design: 6, lipsync: 7 } },
            { id: 'bernie', name: 'Bernie', season: 2, stats: { runway: 9, comedy: 8, acting: 9, dance: 8, design: 8, lipsync: 8 } },
            { id: 'captivating_katkat', name: 'Captivating Katkat', season: 2, stats: { runway: 9, comedy: 8, acting: 7, dance: 9, design: 7, lipsync: 10 } },
            { id: 'deedee_marie_holliday', name: 'DeeDee Marié Holliday', season: 2, stats: { runway: 8, comedy: 7, acting: 7, dance: 8, design: 7, lipsync: 6 } },
            { id: 'hana_beshie', name: 'Hana Beshie', season: 2, stats: { runway: 6, comedy: 8, acting: 7, dance: 7, design: 6, lipsync: 8 } },
            { id: 'm1ss_jade_so', name: 'M1ss Jade So', season: 2, stats: { runway: 9, comedy: 7, acting: 8, dance: 8, design: 9, lipsync: 9 } },
            { id: 'matilduh', name: 'Matilduh', season: 2, stats: { runway: 7, comedy: 7, acting: 6, dance: 7, design: 7, lipsync: 7 } },
            { id: 'nicole_pardaux', name: 'Nicole Pardaux', season: 2, stats: { runway: 8, comedy: 6, acting: 6, dance: 7, design: 6, lipsync: 5 } },
            { id: 'ov_cunt', name: 'ØV Cünt', season: 2, stats: { runway: 10, comedy: 6, acting: 7, dance: 8, design: 9, lipsync: 9 } },
            { id: 'tiny_deluxe', name: 'Tiny DeLuxe', season: 2, stats: { runway: 6, comedy: 7, acting: 7, dance: 7, design: 6, lipsync: 6 } },
            { id: 'veruschka_levels', name: 'Veruschka Levels', season: 2, stats: { runway: 8, comedy: 7, acting: 8, dance: 7, design: 7, lipsync: 6 } },
            // S3 (Recalculated)
            { id: 'maxie', name: 'Maxie', season: 3, stats: { runway: 9, comedy: 10, acting: 9, dance: 7, design: 8, lipsync: 6 } },
            { id: 'khianna', name: 'Khianna', season: 3, stats: { runway: 8, comedy: 7, acting: 8, dance: 8, design: 7, lipsync: 8 } },
            { id: 'angel', name: 'Angel', season: 3, stats: { runway: 7, comedy: 6, acting: 7, dance: 9, design: 9, lipsync: 9 } },
            { id: 'tita_baby', name: 'Tita Baby', season: 3, stats: { runway: 7, comedy: 8, acting: 8, dance: 7, design: 7, lipsync: 8 } },
            { id: 'zymba_ding', name: 'Zymba Ding', season: 3, stats: { runway: 8, comedy: 7, acting: 7, dance: 9, design: 8, lipsync: 7 } },
            { id: 'myx_chanel', name: 'Myx Chanel', season: 3, stats: { runway: 9, comedy: 8, acting: 7, dance: 7, design: 8, lipsync: 8 } },
            { id: 'popstar_bench', name: 'Popstar Bench', season: 3, stats: { runway: 7, comedy: 7, acting: 7, dance: 8, design: 6, lipsync: 8 } },
            { id: 'john_fedellaga', name: 'John Fedellaga', season: 3, stats: { runway: 8, comedy: 8, acting: 8, dance: 7, design: 8, lipsync: 6 } },
            { id: 'j_quinn', name: 'J Quinn', season: 3, stats: { runway: 7, comedy: 6, acting: 6, dance: 7, design: 7, lipsync: 8 } },
            { id: 'yudipota', name: 'Yudipota', season: 3, stats: { runway: 8, comedy: 8, acting: 8, dance: 8, design: 8, lipsync: 8 } },
            { id: 'versex', name: 'Versex', season: 3, stats: { runway: 7, comedy: 6, acting: 6, dance: 7, design: 7, lipsync: 5 } },
        ];
        const challenges = [ { name: "Snatch Game", primaryStat: 'comedy', intro: "The queens must impersonate celebrities in the legendary Snatch Game!" }, { name: "The Rusical", primaryStat: 'dance', intro: "It's time for the Rusical! The queens must sing, dance, and act their hearts out." }, { name: "Girl Groups", primaryStat: 'dance', intro: "Pop star fantasies come alive as the queens form two rival girl groups." }, { name: "Acting Challenge", primaryStat: 'acting', intro: "The queens star in a new teleserye, but who will steal the scene?" }, { name: "Improv", primaryStat: 'comedy', intro: "Queens must think on their feet in a hilarious improv challenge." }, { name: "Sewing", primaryStat: 'design', intro: "Using unconventional materials, the queens must create a look from scratch." }, { name: "The Ball", primaryStat: 'design', intro: "The queens must serve three distinct looks, including one they make themselves, in the legendary Ball." }, { name: "Makeover", primaryStat: 'design', intro: "The queens give drag makeovers to some very special guests!" }, { name: "Talent Show", primaryStat: 'acting', intro: "In the grand premiere, the queens must showcase their unique talents." }, { name: "Roast", primaryStat: 'comedy', intro: "The library is open! The queens must roast the judges and each other." }, ];
        const runwayThemes = ["Filipiniana Extravaganza", "Pearls & Perlas", "Mythical Creatures", "Jeepney Realness", "Divas of the Decades", "Horror-scope", "Terno-dactyl", "Flower Power"];
        const lipsyncSongs = ["'Sirena' by Gloc-9", "'Tala' by Sarah Geronimo", "'Kilometro' by Sarah Geronimo", "'Nosi Balasi' by Sampaguita", "'Shantidope' by Shanti Dope", "'Bongga Ka 'Day' by Hotdog", "'Rampa' by Vice Ganda"];

        // --- NARRATIVE ENGINE ---
        const critiques = {
            comedy: {
                high: ["'s comedic timing was impeccable, leaving the judges in stitches.", "'s celebrity impersonation was spot-on and hilariously funny.", "delivered a knockout performance, with jokes that consistently landed."],
                mid: ["had some funny moments, but the performance was a bit inconsistent.", "took a safe approach that didn't quite stand out.", "'s character was interesting, but needed more punchlines."],
                low: ["'s jokes failed to land, resulting in some awkward silences.", "struggled to find the humor in their character.", "'s performance felt under-rehearsed and missed the mark."]
            },
            dance: {
                high: ["set the stage on fire with their sharp choreography and star quality.", "was a true standout, hitting every beat with precision and energy.", "commanded the stage and proved they are a true dancing diva."],
                mid: ["kept up with the choreography but didn't have a standout moment.", "was solid in the group, but got a little lost in the background.", "showed potential but needed a bit more polish in their moves."],
                low: ["was visibly struggling with the choreography.", "seemed to be a step behind the other queens.", "lacked the energy the performance needed, and it showed."]
            },
            acting: {
                high: ["delivered a powerful and believable performance, stealing every scene they were in.", "showcased incredible range and made a memorable character choice.", "was a natural, bringing humor and heart to their role."],
                mid: ["had their moments but sometimes faded into the background.", "made safe choices that didn't allow their full potential to shine.", "was professional but didn't take enough risks to stand out."],
                low: ["'s performance felt flat and one-note.", "seemed to forget their lines and struggled with their character.", "overacted and their performance felt more like a caricature."]
            },
            design: {
                high: ["constructed a breathtaking garment that looked like it came from a professional designer.", "'s look was creative, well-executed, and told a clear story.", "showed incredible skill, transforming unconventional materials into a high-fashion look."],
                mid: ["'s garment was a good idea but the execution could have been cleaner.", "created a solid look, but it wasn't a showstopper.", "played it safe with a simple silhouette that was well-made but unexciting."],
                low: ["'s garment looked unfinished, with messy hemlines and a confusing silhouette.", "struggled with construction, and the final garment was not flattering.", "had a concept that was better in theory than in execution."]
            },
            runway: {
                high: ["stomped the runway with confidence, selling every inch of their breathtaking look.", "served a look that was pure high fashion and perfectly on theme.", "presented a creative and polished look that left the judges gagged."],
                mid: ["'s runway was nice, but it didn't leave a lasting impression.", "had a good look, but it felt like something we've seen before.", "looked polished, but the look was a little safe for this stage of the competition."],
                low: ["'s runway presentation was underwhelming and the garment was ill-fitting.", "missed the mark on the theme, presenting a confusing look.", "had an interesting idea for the runway, but the execution was sloppy."]
            }
        };

        function generateCritique(queen, stat, score) {
            const level = score > 75 ? 'high' : score > 40 ? 'mid' : 'low';
            const options = critiques[stat][level];
            const critiqueText = options[Math.floor(Math.random() * options.length)];
            // Programmatically add a space if the critique doesn't start with an apostrophe
            const separator = critiqueText.startsWith("'") ? "" : " ";
            return queen.name + separator + critiqueText;
        }

        // --- STATE & DOM ELEMENTS ---
        let gameMode = 'standard';
        let selectedCast = [], currentCast = [], fullCast = [], shuffledChallenges = [], top2 = [];
        let episodeNumber = 1, episodePhase = 'performance', episodeResults = {}, finalScores = [], eliminatedQueen = null;
        const MAX_CAST_SIZE = 15, MIN_CAST_SIZE = 8;
        const menuView = document.getElementById('menu-view'), selectionView = document.getElementById('selection-view'), simulationView = document.getElementById('simulation-view');
        const standardModeBtn = document.getElementById('standard-mode-btn'), rupaulModeBtn = document.getElementById('rupaul-mode-btn');
        const queenGrid = document.getElementById('queen-grid'), castList = document.getElementById('cast-list');
        const castCounter = document.getElementById('cast-counter'), castPlaceholder = document.getElementById('cast-placeholder');
        const startButton = document.getElementById('start-competition-button'), instructions = document.getElementById('instructions');
        const episodeHeader = document.getElementById('episode-header'), phaseSubheader = document.getElementById('phase-subheader');
        const resultsContainer = document.getElementById('results-container'), advanceButton = document.getElementById('advance-button');
        const restartButton = document.getElementById('restart-button');

        // --- CORE LOGIC & SIMULATION FLOW ---
        function selectMode(mode) {
            gameMode = mode;
            menuView.classList.add('hidden');
            selectionView.classList.remove('hidden');
        }

        function startCompetition() {
            fullCast = selectedCast.map(q => ({ ...q, trackRecord: [] }));
            currentCast = [...fullCast];
            episodeNumber = 1;
            shuffledChallenges = [...challenges].sort(() => 0.5 - Math.random());
            selectionView.classList.add('hidden');
            simulationView.classList.remove('hidden');
            runEpisode();
        }

        function runEpisode() {
            const challenge = shuffledChallenges[episodeNumber - 1];
            episodePhase = 'performance';
            episodeHeader.textContent = `Episode ${episodeNumber}: ${challenge.name}`;
            phaseSubheader.innerHTML = `<p class="max-w-2xl mx-auto">${challenge.intro}</p>`;

            finalScores = currentCast.map(q => {
                const perfScore = (q.stats[challenge.primaryStat] * 5) + (Math.random() * 50);
                const runwayScore = (q.stats.runway * 5) + (Math.random() * 50);
                const totalScore = (perfScore * 0.75) + (runwayScore * 0.25);
                return { queen: q, totalScore, perfScore, runwayScore, critiques: {} };
            }).sort((a, b) => b.totalScore - a.totalScore);
            
            finalScores.forEach(s => {
                s.critiques.performance = generateCritique(s.queen, challenge.primaryStat, s.perfScore);
                s.critiques.runway = generateCritique(s.queen, 'runway', s.runwayScore);
            });

            displayAllCritiques(finalScores, challenge);
            advanceButton.textContent = 'Proceed to Judging';
            advanceButton.classList.remove('hidden');
        }
        
        function advanceEpisode() {
            switch (episodePhase) {
                case 'performance': runJudgingPhase(); break;
                case 'placements': runLipSyncPhase(); break;
                case 'lipsync': runTrackRecordPhase(); break;
                case 'trackRecord': 
                    if (currentCast.length <= 4) runFinalePerformancePhase();
                    else { episodeNumber++; runEpisode(); }
                    break;
                case 'finalePerformance': runFinaleTop2Phase(); break;
                case 'finaleTop2': runLipsyncForTheCrownPhase(); break;
            }
        }

        function runJudgingPhase() {
            if (gameMode === 'standard') {
                const placements = assignPlacements(finalScores);
                episodeResults.placements = placements;
                displayPlacements(placements);
                advanceButton.textContent = 'Watch The Lip Sync';
                episodePhase = 'placements';
            } else { // RuPaul Mode
                promptForWinner(finalScores);
            }
        }

        function runLipSyncPhase() {
            episodePhase = 'lipsync';
            phaseSubheader.textContent = `Lip Sync For Your Life!`;
            const bottomQueens = episodeResults.placements.filter(r => r.placement === 'BTM');
            if (bottomQueens.length < 2) { 
                resultsContainer.innerHTML = `<p class="text-center text-lg">Due to the placements, no lip sync is required this week.</p>`;
                eliminatedQueen = bottomQueens.length > 0 ? bottomQueens[0].queen : currentCast[currentCast.length-1];
                handlePostLipSync(null, eliminatedQueen);
                return;
             }
            const [q1, q2] = bottomQueens;
            const q1Score = q1.queen.stats.lipsync * 10 + Math.random() * 15;
            const q2Score = q2.queen.stats.lipsync * 10 + Math.random() * 15;
            const winner = q1Score >= q2Score ? q1 : q2;
            const loser = q1Score < q2Score ? q1 : q2;
            eliminatedQueen = loser.queen;
            handlePostLipSync(winner.queen, loser.queen);
        }

        function handlePostLipSync(winner, loser) {
            const song = lipsyncSongs[Math.floor(Math.random() * lipsyncSongs.length)];
            displayLipSyncResults(winner, loser, song);
            advanceButton.classList.remove('hidden');
            advanceButton.textContent = 'View Track Record';
            episodePhase = 'lipsync';
        }

        function runTrackRecordPhase() {
            episodePhase = 'trackRecord';
            phaseSubheader.textContent = `Season Progress`;
            episodeResults.placements.forEach(p => {
                const queenInFullCast = fullCast.find(q => q.id === p.queen.id);
                if (queenInFullCast) {
                    let finalPlacement = p.placement;
                    if (finalPlacement === 'BTM') {
                        finalPlacement = p.queen.id === eliminatedQueen.id ? 'ELIM' : 'BTM2';
                    }
                    queenInFullCast.trackRecord.push(finalPlacement);
                }
            });
           
            const elimQueenInFullCast = fullCast.find(q => q.id === eliminatedQueen.id);
            if (elimQueenInFullCast) elimQueenInFullCast.eliminated = true;
            currentCast = currentCast.filter(q => q.id !== eliminatedQueen.id);
            
            displayTrackRecord();
            advanceButton.textContent = currentCast.length <= 4 ? 'Start The Finale!' : 'Next Episode';
        }

        // --- RUPAUL MODE PROMPTS ---
        function promptForWinner(scores) {
            phaseSubheader.textContent = "Judges' Deliberations: The Tops";
            const topQueens = scores.slice(0, 3);
            let html = `<div class="text-center mb-6"><h3 class="text-xl font-bold text-pink-400">The judges were blown away by the top queens.</h3><p class="text-gray-400">Based on their critiques, you must choose a winner.</p></div><div class="space-y-3">`;
            topQueens.forEach(s => {
                html += `<button class="secondary-button w-full p-4 rounded-lg text-left" data-winner-id="${s.queen.id}">
                    <p class="font-bold text-lg">${s.queen.name}</p>
                    <p class="text-sm mt-2"><span class="font-semibold">Challenge:</span> ${s.critiques.performance}</p>
                    <p class="text-sm mt-1"><span class="font-semibold">Runway:</span> ${s.critiques.runway}</p>
                </button>`;
            });
            html += `</div>`;
            resultsContainer.innerHTML = html;
            resultsContainer.querySelectorAll('button').forEach(btn => btn.addEventListener('click', () => {
                const winnerId = btn.dataset.winnerId;
                handleWinnerSelection(winnerId, scores);
            }));
            advanceButton.classList.add('hidden');
        }

        function handleWinnerSelection(winnerId, scores) {
            episodeResults.placements = [];
            scores.slice(0, 3).forEach(s => {
                const placement = s.queen.id === winnerId ? 'WIN' : 'HIGH';
                episodeResults.placements.push({ queen: s.queen, placement });
            });
            promptForBottoms(scores);
        }

        function promptForBottoms(scores) {
            phaseSubheader.textContent = "Judges' Deliberations: The Bottoms";
            const bottomQueens = scores.slice(-3);
            let html = `<div class="text-center mb-6"><h3 class="text-xl font-bold text-pink-400">Unfortunately, three queens failed to impress.</h3><p class="text-gray-400">You must save one from the lip sync.</p></div><div class="space-y-3">`;
            bottomQueens.forEach(s => {
                html += `<button class="secondary-button w-full p-4 rounded-lg text-left" data-safe-id="${s.queen.id}">
                    <p class="font-bold text-lg">${s.queen.name}</p>
                    <p class="text-sm mt-2"><span class="font-semibold">Challenge:</span> ${s.critiques.performance}</p>
                    <p class="text-sm mt-1"><span class="font-semibold">Runway:</span> ${s.critiques.runway}</p>
                </button>`;
            });
            html += `</div>`;
            resultsContainer.innerHTML = html;
            resultsContainer.querySelectorAll('button').forEach(btn => btn.addEventListener('click', () => {
                const safeId = btn.dataset.safeId;
                handleBottomSelection(safeId, scores);
            }));
        }

        function handleBottomSelection(safeId, scores) {
            scores.slice(-3).forEach(s => {
                const placement = s.queen.id === safeId ? 'LOW' : 'BTM';
                episodeResults.placements.push({ queen: s.queen, placement });
            });
            scores.slice(3, -3).forEach(s => episodeResults.placements.push({ queen: s.queen, placement: 'SAFE' }));
            promptForLipSyncWinner();
        }

        function promptForLipSyncWinner() {
            phaseSubheader.textContent = `Lip Sync For Your Life!`;
            const bottomQueens = episodeResults.placements.filter(p => p.placement === 'BTM').map(p => finalScores.find(s => s.queen.id === p.queen.id));
            const [s1, s2] = bottomQueens;
            const song = lipsyncSongs[Math.floor(Math.random() * lipsyncSongs.length)];
            let html = `<div class="text-center mb-6"><h3 class="text-xl font-bold text-pink-400">Two queens stand before me.</h3><p class="text-gray-400">They will lip sync to ${song}. Based on their passion and performance, you decide who stays.</p></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4">`;
            
            const createButton = (s) => `<button class="secondary-button w-full p-4 rounded-lg" data-winner-id="${s.queen.id}">
                <p class="text-xl font-bold">${s.queen.name}</p>
                <div class="text-sm mt-2 text-left">
                    <p><span class="font-semibold">Lip Sync Stat:</span> ${s.queen.stats.lipsync}/10</p>
                    <p class="mt-2"><span class="font-semibold">Critiques:</span> ${s.critiques.performance}</p>
                </div>
            </button>`;

            html += createButton(s1);
            html += createButton(s2);
            html += `</div>`;
            resultsContainer.innerHTML = html;
            resultsContainer.querySelectorAll('button').forEach(btn => btn.addEventListener('click', () => {
                const winnerId = btn.dataset.winnerId;
                const winner = winnerId === s1.queen.id ? s1.queen : s2.queen;
                const loser = winnerId === s1.queen.id ? s2.queen : s1.queen;
                eliminatedQueen = loser;
                handlePostLipSync(winner, loser);
            }));
        }
        
        // --- DISPLAY & UTILITY FUNCTIONS ---
        function displayAllCritiques(scores, challenge) {
            const theme = runwayThemes[Math.floor(Math.random() * runwayThemes.length)];
            let html = `<div class="text-center mb-6"><h3 class="text-xl font-bold text-pink-400">Runway Theme: ${theme}</h3><p class="text-gray-400">The judges have watched the performances and seen the runways. Here are their thoughts...</p></div>`;
            html += '<div class="space-y-4">';
            scores.forEach(s => {
                const scoreLevel = s.totalScore > 75 ? 'good' : s.totalScore > 40 ? 'safe' : 'bad';
                html += `<div class="critique-card critique-${scoreLevel} bg-gray-800 p-4 rounded-lg">
                    <p class="font-bold text-lg">${s.queen.name}</p>
                    <p class="text-sm mt-2"><span class="font-semibold">Challenge:</span> ${s.critiques.performance}</p>
                    <p class="text-sm mt-1"><span class="font-semibold">Runway:</span> ${s.critiques.runway}</p>
                </div>`;
            });
            html += '</div>';
            resultsContainer.innerHTML = html;
        }
        
        function assignPlacements(results) { /* ... Same as before ... */ }
        function displayPlacements(placements) { /* ... Same as before ... */ }
        function displayLipSyncResults(winner, loser, song) {
             let narrative;
             if(winner){
                 narrative = `Both queens gave it their all, but ${winner.name}'s passion and precision on stage gave her the edge. She truly embodied the spirit of the song.`;
             } else {
                 narrative = `A shocking turn of events! The judges have made a difficult decision.`
             }
             resultsContainer.innerHTML = `<div class="text-center space-y-4 max-w-2xl mx-auto">
                <p class="text-lg">The bottom two queens lip sync to ${song}!</p>
                <p class="text-gray-300 italic">"${narrative}"</p>
                ${winner ? `<p class="text-2xl font-bold text-green-400 pt-4">Shantay, you stay, ${winner.name}.</p>` : ''}
                <p class="text-xl mt-2 text-red-400">${loser.name}, sashay away.</p>
            </div>`;
        }
        function calculateTrackRecordScore(queen) { /* ... Same as before ... */ }
        function displayTrackRecord() { /* ... Same as before ... */ }
        function runFinalePerformancePhase() { /* ... Same as before ... */ }
        function runFinaleTop2Phase() { /* ... Same as before ... */ }
        function promptForTop2() { /* ... Same as before ... */ }
        function displayTop2Results(top2, eliminated) { /* ... Same as before ... */ }
        function runLipsyncForTheCrownPhase() { /* ... Same as before ... */ }
        function promptForWinnerCrown(q1, q2, score1, score2) { /* ... Same as before ... */ }
        function displayWinner(winner, runnerUp) { /* ... Same as before ... */ }
        function updateSelectionUI() { /* ... Same as before ... */ }
        function toggleQueenSelection(queen) { /* ... Same as before ... */ }

        // --- All functions from here down are restored to be complete ---
        function assignPlacements(results) {
            const len = results.length;
            if (len === 0) return [];
            return results.map((r, i) => {
                let placement;
                if (i === 0) placement = 'WIN';
                else if (len > 5 && i <= 2) placement = 'HIGH';
                else if (i >= len - 2) placement = 'BTM';
                else if (len > 4 && i === len - 3) placement = 'LOW';
                else placement = 'SAFE';
                return { queen: r.queen, placement: placement };
            });
        }
        function displayPlacements(placements) {
            phaseSubheader.textContent = "The Judges have made their decisions...";
            let html = '<div class="space-y-2">';
            placements.sort((a, b) => {
                const order = { 'WIN': 0, 'HIGH': 1, 'SAFE': 2, 'LOW': 3, 'BTM': 4 };
                return order[a.placement] - order[b.placement];
            }).forEach(({queen, placement}) => {
                const placementText = placement === 'BTM' ? 'BTM 2' : placement;
                html += `<div class="placement-${placement} p-3 rounded-lg flex items-center justify-between"><span class="font-bold text-lg">${queen.name}</span><span class="font-black text-lg tracking-wider">${placementText}</span></div>`;
            });
            resultsContainer.innerHTML = `<div class="text-center mb-4"><p class="text-lg italic text-gray-400">After careful deliberation...</p></div>` + html;
        }
        function calculateTrackRecordScore(queen) {
            const placementScores = { 'WIN': 5, 'HIGH': 4, 'SAFE': 3, 'LOW': 2, 'BTM2': 1, 'ELIM': 0 };
            return queen.trackRecord.reduce((acc, placement) => acc + (placementScores[placement] || 0), 0);
        }
        function displayTrackRecord() {
            const placementOrder = { 'WIN': 0, 'HIGH': 1, 'SAFE': 2, 'LOW': 3, 'BTM2': 4, 'ELIM': 5 };
            const lastEpisodeIndex = episodeNumber - 1;
            const sortedCast = [...fullCast].sort((a, b) => {
                if (a.eliminated && !b.eliminated) return 1;
                if (!a.eliminated && b.eliminated) return -1;
                const placementA = a.trackRecord[lastEpisodeIndex];
                const placementB = b.trackRecord[lastEpisodeIndex];
                const scoreA = placementOrder[placementA] ?? 100;
                const scoreB = placementOrder[placementB] ?? 100;
                return scoreA - scoreB;
            });

            let tableHTML = `<div class="overflow-x-auto"><table class="w-full text-xs md:text-sm track-record-table"><thead><tr><th class="text-left">Queen</th>`;
            for (let i = 0; i < episodeNumber; i++) { 
                const challengeName = shuffledChallenges[i]?.name || `Ep ${i+1}`;
                tableHTML += `<th><div class="flex flex-col items-center"><span>Ep ${i + 1}</span><span class="font-normal text-gray-400 text-xs">${challengeName}</span></div></th>`; 
            }
            tableHTML += `</tr></thead><tbody>`;
            sortedCast.forEach(queen => {
                tableHTML += `<tr class="${queen.eliminated ? 'opacity-50' : ''}"><td class="text-left font-bold">${queen.name}</td>`;
                for (let i = 0; i < episodeNumber; i++) {
                    const placement = queen.trackRecord[i] || '';
                    tableHTML += `<td class="placement-${placement}">${placement}</td>`;
                }
                tableHTML += `</tr>`;
            });
            tableHTML += `</tbody></table></div>`;
            resultsContainer.innerHTML = tableHTML;
        }
        function runFinalePerformancePhase() {
            episodePhase = 'finalePerformance';
            episodeHeader.textContent = 'The Grand Finale';
            phaseSubheader.textContent = 'For the crown, the queens must write, record, and perform their own verse in a rumix of a RuPaul classic!';
            episodeResults.finalePerformance = currentCast.map(q => {
                const stats = q.stats;
                const overallStat = (stats.runway + stats.acting + stats.dance) / 3;
                const score = (overallStat * 10) + (Math.random() * 20);
                return { queen: q, score: score };
            }).sort((a, b) => b.score - a.score);
             if(gameMode === 'standard'){
                runFinaleTop2Phase();
             } else {
                promptForTop2();
             }
        }
        function runFinaleTop2Phase(){
            episodePhase = 'finaleTop2';
            phaseSubheader.textContent = 'Choosing the Top 2';
            const finaleScores = currentCast.map(queen => {
                const trackRecordScore = calculateTrackRecordScore(queen);
                const perfScore = episodeResults.finalePerformance.find(r => r.queen.id === queen.id).score;
                const maxPerfScore = Math.max(...episodeResults.finalePerformance.map(r => r.score));
                const normalizedPerf = (perfScore / maxPerfScore) * 100;
                const maxTrackRecord = Math.max(...currentCast.map(q => calculateTrackRecordScore(q)));
                const normalizedTrack = maxTrackRecord > 0 ? (trackRecordScore / maxTrackRecord) * 100 : 0;
                const totalScore = (normalizedTrack * 0.5) + (normalizedPerf * 0.5);
                return { queen, totalScore, trackRecordScore };
            }).sort((a, b) => b.totalScore - a.totalScore);
            top2 = [finaleScores[0], finaleScores[1]];
            const eliminated = currentCast.filter(q => !top2.some(t => t.queen.id === q.id));
            displayTop2Results(top2, eliminated);
            advanceButton.textContent = 'Lip Sync For The Crown!';
        }
        function promptForTop2() {
            let html = `<div class="text-center mb-6"><h3 class="text-xl font-bold text-pink-400">Four Queens, one crown.</h3><p class="text-gray-400">Based on their final performance and their journey so far, choose your Top 2.</p></div><div class="space-y-3">`;
            let selectedTop2 = [];

            episodeResults.finalePerformance.forEach(s => {
                html += `<button class="secondary-button w-full p-4 rounded-lg text-left" data-top2-id="${s.queen.id}">
                    <div class="flex justify-between items-center">
                        <span class="text-lg font-bold">${s.queen.name}</span>
                        <div>
                            <span class="text-sm text-gray-400">Finale Perf: ${s.score.toFixed(0)}</span>
                            <span class="text-sm text-gray-400 ml-2">Track Record: ${calculateTrackRecordScore(s.queen)}</span>
                        </div>
                    </div>
                </button>`;
            });
            html += `</div>`;
            resultsContainer.innerHTML = html;
            resultsContainer.querySelectorAll('button').forEach(btn => btn.addEventListener('click', () => {
                btn.classList.toggle('bg-pink-600');
                const queenId = btn.dataset.top2Id;
                if(selectedTop2.includes(queenId)){
                    selectedTop2 = selectedTop2.filter(id => id !== queenId);
                } else if (selectedTop2.length < 2) {
                    selectedTop2.push(queenId);
                }

                if(selectedTop2.length === 2) {
                    const topQueens = currentCast.filter(q => selectedTop2.includes(q.id));
                    const elimQueens = currentCast.filter(q => !selectedTop2.includes(q.id));
                    top2 = topQueens.map(q => ({queen: q, trackRecordScore: calculateTrackRecordScore(q)}));
                    displayTop2Results(top2, elimQueens);
                    advanceButton.classList.remove('hidden');
                    advanceButton.textContent = 'Lip Sync For The Crown!';
                    episodePhase = 'finaleTop2';
                }
            }));
             advanceButton.classList.add('hidden');
        }
        function displayTop2Results(top2, eliminated) {
            resultsContainer.innerHTML = `
                <div class="text-center space-y-4 max-w-2xl mx-auto">
                    <p class="text-xl font-bold">Based on the final performance and season-long track record, the Top 2 queens are...</p>
                    <div class="p-4 rounded-lg bg-green-600 text-2xl font-black">${top2[0].queen.name}</div>
                    <div class="p-4 rounded-lg bg-green-600 text-2xl font-black">${top2[1].queen.name}</div>
                    <p class="text-lg pt-4">This means, ${eliminated.map(q=>q.name).join(' and ')}, I'm sorry my dears but this is not your time. Sashay away.</p>
                </div>
            `;
        }
        function runLipsyncForTheCrownPhase() {
            episodePhase = 'lipsyncForTheCrown';
            phaseSubheader.textContent = 'The Final Showdown';
            
            const [q1, q2] = top2;
            const q1LipSync = q1.queen.stats.lipsync * 10 + Math.random() * 25;
            const q2LipSync = q2.queen.stats.lipsync * 10 + Math.random() * 25;

            if(gameMode === 'standard'){
                const maxLipSync = Math.max(q1LipSync, q2LipSync);
                const normalizedLipSync1 = maxLipSync > 0 ? (q1LipSync / maxLipSync) * 100 : 0;
                const normalizedLipSync2 = maxLipSync > 0 ? (q2LipSync / maxLipSync) * 100 : 0;
                const maxTrackRecord = Math.max(q1.trackRecordScore, q2.trackRecordScore);
                const normalizedTrack1 = maxTrackRecord > 0 ? (q1.trackRecordScore / maxTrackRecord) * 100 : 0;
                const normalizedTrack2 = maxTrackRecord > 0 ? (q2.trackRecordScore / maxTrackRecord) * 100 : 0;
                const finalScore1 = (normalizedTrack1 * 0.8) + (normalizedLipSync1 * 0.2);
                const finalScore2 = (normalizedTrack2 * 0.8) + (normalizedLipSync2 * 0.2);
                const winner = finalScore1 >= finalScore2 ? q1.queen : q2.queen;
                const runnerUp = finalScore1 < finalScore2 ? q1.queen : q2.queen;
                displayWinner(winner, runnerUp);
            } else {
                promptForWinnerCrown(q1.queen, q2.queen, q1LipSync, q2LipSync);
            }
        }
        function promptForWinnerCrown(q1, q2, score1, score2){
             let html = `<div class="text-center mb-6"><h3 class="text-xl font-bold text-pink-400">The time has come... to lip sync... for the CROWN!</h3><p class="text-gray-400">Who delivered the winning performance?</p></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4">`;
            
            const createButton = (q, score) => `<button class="secondary-button w-full p-4 rounded-lg" data-winner-id="${q.id}">
                <p class="text-xl font-bold">${q.name}</p>
                <div class="text-sm mt-2 text-left">
                    <p><span class="font-semibold">Lip Sync Performance Score:</span> ${score.toFixed(0)}</p>
                    <p><span class="font-semibold">Final Track Record:</span> ${calculateTrackRecordScore(q)}</p>
                </div>
            </button>`;

            html += createButton(q1, score1);
            html += createButton(q2, score2);
            html += `</div>`;
            resultsContainer.innerHTML = html;
            resultsContainer.querySelectorAll('button').forEach(btn => btn.addEventListener('click', () => {
                const winnerId = btn.dataset.winnerId;
                const winner = winnerId === q1.id ? q1 : q2;
                const runnerUp = winnerId === q1.id ? q2 : q1;
                displayWinner(winner, runnerUp);
}));
            advanceButton.classList.add('hidden');
        }
        function displayWinner(winner, runnerUp) {
            resultsContainer.innerHTML = `
                <div class="text-center space-y-4 max-w-2xl mx-auto">
                    <p class="text-xl">Ladies, the decision is final...</p>
                    <p class="text-2xl font-bold">The next Drag Race Philippines Superstar is...</p>
                    <div class="py-8">
                        <p class="text-5xl md:text-7xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 to-amber-500 animate-pulse">${winner.name}</p>
                    </div>
                    <p class="text-2xl font-bold">Condragulations, you're a winner, baby!</p>
                    <p class="text-lg pt-4">And to our runner-up, ${runnerUp.name}, you are and will always be a star. Now, prance, my queen!</p>
                </div>`;
            advanceButton.classList.add('hidden');
            restartButton.classList.remove('hidden');
        }

        function updateSelectionUI() {
            castList.innerHTML = '';
            castPlaceholder.style.display = selectedCast.length === 0 ? 'block' : 'none';
            selectedCast.forEach(q => {
                const li = document.createElement('div');
                li.className = 'flex items-center bg-gray-800 p-2 rounded-lg';
                li.innerHTML = `<img src="https://placehold.co/40x40/1F2937/EC4899?text=${encodeURIComponent(q.name.split(' ').map(n=>n[0]).join(''))}" class="w-8 h-8 rounded-full mr-3"><span class="font-bold text-sm">${q.name}</span>`;
                castList.appendChild(li);
            });
            castCounter.textContent = `Selected: ${selectedCast.length} / ${MAX_CAST_SIZE}`;
            const size = selectedCast.length;
            startButton.disabled = !(size >= MIN_CAST_SIZE && size <= MAX_CAST_SIZE);
            instructions.textContent = startButton.disabled ? (size < MIN_CAST_SIZE ? `Select at least ${MIN_CAST_SIZE - size} more queen(s).` : `Select between ${MIN_CAST_SIZE} and ${MAX_CAST_SIZE} queens.`) : 'Your cast is ready!';
            document.querySelectorAll('.queen-card').forEach(c => c.classList.toggle('selected', selectedCast.some(q => q.id === c.dataset.id)));
        }
        function toggleQueenSelection(queen) {
            const i = selectedCast.findIndex(q => q.id === queen.id);
            if (i > -1) selectedCast.splice(i, 1);
            else if (selectedCast.length < MAX_CAST_SIZE) selectedCast.push(queen);
            updateSelectionUI();
        }

        // --- INITIALIZATION ---
        window.addEventListener('load', () => {
            standardModeBtn.addEventListener('click', () => selectMode('standard'));
            rupaulModeBtn.addEventListener('click', () => selectMode('rupaul'));

            const sortedQueens = queens.sort((a,b) => (a.season - b.season) || a.name.localeCompare(b.name));
            let currentSeason = 0;
            sortedQueens.forEach(q => {
                if(q.season !== currentSeason) {
                    currentSeason = q.season;
                    const h = document.createElement('div');
                    h.className = 'col-span-full text-center text-pink-400 font-bold py-2 tracking-widest uppercase';
                    h.textContent = `Season ${currentSeason}`;
                    queenGrid.appendChild(h);
                }
                const card = document.createElement('div');
                card.className = 'queen-card bg-gray-800 rounded-lg p-2 text-center cursor-pointer border-2 border-transparent';
                card.dataset.id = q.id;
                card.innerHTML = `<img src="https://placehold.co/150x150/1F2937/EC4899?text=${encodeURIComponent(q.name.replace(/\s+/g, '\n'))}" class="w-full h-auto rounded-md"><p class="mt-2 text-xs font-bold truncate">${q.name}</p>`;
                card.addEventListener('click', () => toggleQueenSelection(q));
                queenGrid.appendChild(card);
            });
            
            startButton.addEventListener('click', () => { if (!startButton.disabled) startCompetition(); });
            advanceButton.addEventListener('click', advanceEpisode);
            restartButton.addEventListener('click', () => window.location.reload());
        });
    </script>
</body>
</html>


